<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF to AVIF Converter</title>
    
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="manifest" href="site.webmanifest">

    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; color: #333; }
        .container { max-width: 700px; margin: auto; }
        
        .controls {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            gap: 15px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .control-group label {
            width: 80px; 
            font-weight: bold;
        }
        .control-group input[type="number"] {
            width: 60px;
            padding: 5px;
        }
        .control-group input[type="range"] {
            flex-grow: 1;
            cursor: pointer;
        }
        .control-group.checkbox {
            justify-content: flex-start;
            cursor: pointer;
        }
        .control-group.checkbox input {
            width: auto;
            cursor: pointer;
        }
        .help-text {
            font-size: 0.8em;
            color: #666;
            margin-left: 10px;
            white-space: nowrap;
        }

        #status { margin: 10px 0; font-weight: bold; }
        #output { margin-top: 20px; text-align: center; }
        img { max-width: 100%; border: 1px solid #ddd; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .error { color: #d9534f; }
    </style>
</head>
<body>
    <div class="container">
        <h2>GIF to Transparent AVIF Converter</h2>

        <div class="controls">
            <div class="control-group">
                <label for="fpsNum">FPS:</label>
                <input type="number" id="fpsNum" value="30" min="1" max="60">
                <input type="range" id="fpsSlider" min="1" max="60" value="30">
                <span class="help-text">Output framerate</span>
            </div>

            <div class="control-group">
                <label for="crfNum">CRF:</label>
                <input type="number" id="crfNum" value="100" min="0" max="255">
                <input type="range" id="crfSlider" min="0" max="255" value="100">
                <span class="help-text">Quality (0=Lossless, 255=Worst)</span>
            </div>

            <div class="control-group">
                <label for="speedNum">Enc Speed:</label>
                <input type="number" id="speedNum" value="6" min="0" max="10">
                <input type="range" id="speedSlider" min="0" max="10" value="6">
                <span class="help-text">CPU Usage (0=Slow, 10=Fast)</span>
            </div>

            <div class="control-group">
                <label for="playbackNum">Playback:</label>
                <input type="number" id="playbackNum" value="1.0" min="0.1" max="4.0" step="0.1">
                <input type="range" id="playbackSlider" min="0.1" max="4.0" step="0.1" value="1.0">
                <span class="help-text">Multiplier (0.5=Slow, 2.0=Fast)</span>
            </div>

            <div class="control-group checkbox">
                <label for="interpolateCheck" style="width: auto; margin-right: 10px;">Interpolate Frames:</label>
                <input type="checkbox" id="interpolateCheck">
                <span class="help-text">Smoother motion (slower encoding)</span>
            </div>
        </div>

        <input type="file" id="upload" accept="image/gif">
        
        <div id="status">Loading WASM...</div>
        <div id="output"></div>
    </div>

    <script type="module">
        
        const status = document.getElementById('status');
        const output = document.getElementById('output');
        const upload = document.getElementById('upload');
        let worker;

        function syncInputs(sliderId, numId) {
            const slider = document.getElementById(sliderId);
            const num = document.getElementById(numId);
            
            slider.addEventListener('input', () => num.value = slider.value);
            num.addEventListener('input', () => slider.value = num.value);
        }

        syncInputs('fpsSlider', 'fpsNum');
        syncInputs('crfSlider', 'crfNum');
        syncInputs('speedSlider', 'speedNum');
        syncInputs('playbackSlider', 'playbackNum');

        function initWorker() {
            worker = new Worker(new URL('./worker.js', import.meta.url), { type: 'module' });

            worker.onmessage = (e) => {
                const msg = e.data;
                if (msg.status === 'ready') {
                    status.innerText = "Ready. Configure settings and upload GIF.";
                    status.style.color = "green";
                    upload.disabled = false;
                } else if (msg.status === 'success') {
                    const blob = new Blob([msg.data], { type: 'image/avif' });
                    const url = URL.createObjectURL(blob);
                    
                    output.innerHTML = '';
                    
                    const img = document.createElement('img');
                    img.src = url;
                    
                    output.appendChild(img);
                    status.innerText = "Success!";
                } else if (msg.status === 'error') {
                    status.innerText = "Error: " + msg.error;
                    status.className = "error";
                }
            };
        }

        initWorker();

        upload.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const fps = parseInt(document.getElementById('fpsNum').value, 10);
            const crf = parseInt(document.getElementById('crfNum').value, 10);
            const encSpeed = parseInt(document.getElementById('speedNum').value, 10);
            const playbackSpeed = parseFloat(document.getElementById('playbackNum').value);
            const interpolate = document.getElementById('interpolateCheck').checked;

            status.innerText = `Converting... (Encoding might still take time, check console)`;
            output.innerHTML = "";

            const reader = new FileReader();
            reader.onload = (e) => {
                const bytes = new Uint8Array(e.target.result);
                worker.postMessage({
                    fileData: bytes,
                    fps, crf, encSpeed, playbackSpeed, interpolate
                }, [bytes.buffer]);
            };
            reader.readAsArrayBuffer(file);
        });
    </script>
</body>
</html>
